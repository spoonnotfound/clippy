# 剪切板存储引擎

## 概述

这是一个为剪切板管理器开发的自定义存储引擎，实现了顺序写入和标记删除机制。

## 核心特性

### 1. 顺序写入 (Append-Only)
- 所有操作都以追加方式写入日志文件
- 每次写入都立即刷新到磁盘，确保数据不丢失
- 高性能的顺序 I/O 操作

### 2. 标记删除 (Tombstone)
- 删除操作不直接从文件中移除数据
- 而是写入删除标记，标明某个项目已被删除
- 保留完整的操作历史

### 3. 内存索引
- 维护内存中的索引，提供快速查询
- 启动时从日志文件恢复索引
- 实时更新索引状态

## 存储格式

每条记录包含以下字段：
```
- 操作类型 (1 字节): INSERT(1) 或 DELETE(2)
- 时间戳 (8 字节): 操作时间戳
- 项目ID长度 (4 字节): 项目ID的字节长度
- 项目ID (变长): 项目唯一标识符
- 数据长度 (4 字节): JSON数据的字节长度
- 数据 (变长): 项目的JSON序列化数据
```

## API

### 基本操作
- `insert(item)`: 插入新的剪切板项目
- `delete(item_id)`: 标记删除指定项目
- `get_all()`: 获取所有有效项目
- `clear_all()`: 标记删除所有项目

### 维护操作
- `stats()`: 获取存储统计信息
- `compact()`: 压缩存储文件，移除已删除的记录

## 优势

1. **数据安全**: 顺序写入确保数据完整性
2. **高性能**: 内存索引提供快速查询
3. **可恢复**: 启动时自动从日志恢复数据
4. **可维护**: 支持压缩操作，清理无效数据

## 存储位置

- 存储目录: `./clippy_data/`
- 日志文件: `clipboard.log`
- 临时文件: `clipboard.tmp` (压缩时使用)

## 使用示例

```rust
// 创建存储引擎
let storage = StorageEngine::new(PathBuf::from("./clippy_data"))?;

// 插入项目
storage.insert(&clipboard_item)?;

// 删除项目
storage.delete("item_id")?;

// 获取所有项目
let items = storage.get_all();

// 获取统计信息
let stats = storage.stats();

// 压缩存储
storage.compact()?;
``` 